<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="password-reset.css" />
    <link rel="stylesheet" type="text/css" href="/global.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/global.css" />
    <title>Сброс пароля</title>
    <link rel="icon" href="/icons/web-favicon.svg" type="image/x-icon" />
  </head>

  <body>
    <div class="register_block">
      <div class="register_header">
        <p class="register_text">Сбросить пароль</p>
      </div>
      <div class="form_register">
        <div class="register_inputs">
          <div class="email_name_block">
            <div class="email">
              <label>Email</label>
              <input id="email" type="email" placeholder="Введите ваш Email" />
              <label id="email-error-label" for="" class="input-error-label none"></label>
              <p class="forgot_text">Укажите Email, который вы указывали при регистрации.</p>
            </div>
          </div>
        </div>
        <button class="btn">Отправить сообщение</button>
      </div>
    </div>
    <script src="/js/token.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="../js/index.js"></script>
    <script>
      // Получаем кнопку сброса пароля
      const resetBtn = document.querySelector('.btn');
      // Устанавливаем ширину кнопки на 100%
      resetBtn.style.width = '100%';

      // Функция для сброса пароля
      function handleForgotPassword() {
        // Получаем значение email из поля ввода
        const email = document.querySelector('#email').value;
        // Создаем объект FormData и добавляем в него email
        const formData = new FormData();
        formData.append('login', email);
        // Отправляем POST запрос на сервер для сброса пароля
        fetch(`${base_url}accounts/send-reset-password-link/`, {
          method: 'POST',
          headers: headers,
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              console.log(response.status);
            }
            window.location.href = '/send-reset-password/send-reset-password.html';
            return response.json();
          })
          .then((data) => {
            if (!data.success) {
              handleErrors(data);
            } else {
              window.location.href = '/send-reset-password/send-reset-password.html';
            }
          });
      }

      // Функция для обработки ошибок
      function handleErrors(data) {
        // Список полей с ошибками
        const inputs = ['email'];
        inputs.forEach((el) => {
          const errorInput = document.querySelector(`#${el}`);
          const errorInputLabel = document.querySelector(`#${el}-error-label`);
          if (data.login) {
            // Если есть ошибки, добавляем класс ошибки и отображаем сообщение
            errorInput.classList.add('error-input');
            errorInputLabel.classList.remove('none');
            errorInputLabel.textContent = translateError(data.login[0]);
          } else {
            // Иначе удаляем класс ошибки и скрываем сообщение
            errorInput.classList.remove('error-input');
            errorInputLabel.classList.add('none');
            errorInputLabel.textContent = '';
          }
        });
      }
      resetBtn.addEventListener('click', handleForgotPassword);
    </script>
  </body>
</html>
