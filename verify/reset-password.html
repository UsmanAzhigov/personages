<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Мета-теги для кодировки и настройки масштабирования -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Подключение таблиц стилей -->
    <link rel="stylesheet" href="./reset-password.css" />
    <link rel="stylesheet" href="/global.css" />

    <!-- Иконка сайта -->
    <link rel="icon" href="/icons/web-favicon.svg" type="image/x-icon" />
  </head>

  <body>
    <!-- Блок регистрации -->
    <div class="register_block">
      <!-- Заголовок регистрации -->
      <div class="register_header">
        <p class="register_text">Задать новый пароль</p>
      </div>

      <!-- Форма регистрации -->
      <div class="form_register">
        <div class="register_inputs">
          <!-- Блок для пароля -->
          <div class="password_block">
            <div class="password">
              <!-- Поле для нового пароля -->
              <label>Новый пароль</label>
              <div class="input_password">
                <input id="password" type="password" placeholder="Введите новый пароль" />
                <img class="eye_icon" width="24px" height="24px" src="/icons/closeEyeIcon.svg" />
              </div>
              <!-- Подсказка к полю ввода пароля -->
              <label class="input_helperText">
                <b>Новый пароль</b> будет использоваться для входа в аккаунт
              </label>
              <!-- Метка ошибки для поля ввода пароля -->
              <label id="password-error-label" for="" class="input-error-label none"></label>
            </div>
          </div>
        </div>
        <!-- Кнопка для задания нового пароля -->
        <button class="btn">Задать новый пароль</button>
      </div>
    </div>

    <!-- Подключение скриптов -->
    <script src="/js/token.js"></script>
    <script src="/js/index.js"></script>
    <script>
      // Обработка смены видимости пароля
      const eyeIcon = document.querySelector('.eye_icon');
      const resetBtn = document.querySelector('.btn');
      resetBtn.style.width = '100%';
      resetBtn.style.marginTop = '12px';
      eyeIcon.addEventListener('click', () => {
        if (document.getElementById('password').type === 'password') {
          document.getElementById('password').type = 'text';
          eyeIcon.src = '/icons/eyeIcon.svg';
        } else {
          document.getElementById('password').type = 'password';
          eyeIcon.src = '/icons/closeEyeIcon.svg';
        }
      });

      // Получение параметров из URL
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          user_id: params.get('user_id'),
          timestamp: params.get('timestamp'),
          signature: params.get('signature'),
        };
      }
      const { user_id, timestamp, signature } = getUrlParams();

      // Обработчик нажатия на кнопку "Задать новый пароль"
      resetBtn.addEventListener('click', () => {
        const password = document.getElementById('password').value;
        handleResetPassword(
          user_id,
          timestamp,
          signature,
          password,
          headers,
          base_url,
          handleErrors,
        );
      });

      // Обработка ошибок
      function handleErrors(data) {
        const inputs = ['password'];

        inputs.forEach((el) => {
          const errorInput = document.querySelector(`#${el}`);
          const errorInputLabel = document.querySelector(`#${el}-error-label`);
          const helperText = document.querySelector(`.input_helperText`);
          if (data[el]) {
            if (errorInput) {
              errorInput.classList.add('error-input');
              errorInputLabel?.classList.remove('none');
              errorInputLabel.textContent = translateError(data[el][0]);
              helperText.textContent = '';
            }
          } else {
            if (errorInput) {
              errorInput?.classList?.remove('error-input');
              errorInputLabel?.classList?.add('none');
            }
          }
        });
      }
    </script>
  </body>
</html>
